#!/usr/bin/env zsh

# --------------------------------------------------------------------------
#   ZSH → bin → Enedos (Homelab)
# --------------------------------------------------------------------------

source $HOME/.env
source $DOTFILES_PATH_ZSH/log

# Set variables
# @NOTE The following are stored in .env: $ENEDOS_USER, $NODES, $SSH_KEY
MODE="ssh"
TARGET=""

# Intro flag
log_intro "Enedos"

# Check arguments
while getopts "n:prt" flag; do
    case ${flag} in
		n) TARGET="$OPTARG" ;;
    p) MODE="pull" ;;
    r) MODE="reboot" ;;
    t) MODE="test" ;;
    *) log_error_exit "Invalid option" ;;
    esac
done

if [[ $MODE == 'ssh' && -z $TARGET ]]; then
  log_error_exit "SSH mode needs a node. Run again with -n option."
  exit 1
fi


if [[ $MODE == 'ssh' ]]; then
  log_step "Connecting to ${NODES[$TARGET]}..."
  ssh $ENEDOS_USER@$NODES["$TARGET"]
fi


if [[ $MODE == 'reboot' ]]; then
  for IP in "${(@v)NODES}"; do
    log_step "Rebooting $IP..."
		ssh -i $SSH_KEY -t $ENEDOS_USER@$IP "systemctl reboot";
    log_success "$IP is now rebooting"
	done
  log_success_exit "Enedos rebooted.";
fi

if [[ $MODE == 'pull' ]]; then
  for IP in "${(@v)NODES}"; do
    log_step "Pulling latest for $IP..."
		ssh -i $SSH_KEY -t $ENEDOS_USER@$IP "cd ~/enedos/helpers; git pull";
    log_success "Git repository pulled for $IP"
	done
  log_success_exit "Enedos has latest.";
fi

if [[ $MODE == 'test' ]]; then
  log_note "A test note"
  log_error "A test error"
  log_warning "A test warning"
  log_step "A test step"
  log_success "A succesful test"
fi